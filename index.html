<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام محاسبة - ملف واحد (Tailwind + Chart.js)</title>

  <!-- ============================
       Tailwind CSS (CDN) - لتصميم احترافي وسريع
       نستخدم السكربت الرسمي لتوليد Tailwind في الوقت الحقيقي عبر CDN.
       ============================ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- تهيئة سريعة للـ Tailwind (تمكين dark mode عبر class) -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#0f172a', // لون رئيسي غامق
            accent: '#0ea5e9'   // لون مسانِد
          }
        }
      }
    }
  </script>

  <!-- ============================
       Chart.js (مكتبة الرسوم البيانية)
       نسخة حديثة من CDN
       ============================ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ============================
       Lucide Icons (أيقونات خفيفة)
       سنستخدم النسخة الممولة عبر CDN ونولّد الأيقونات ديناميكياً
       ============================ -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/lucide@0.259.0/dist/lucide.esm.js"></script>

  <!-- ============================
       ستايل إضافي صغير (لتحسين الظلال والانتقالات)
       كل شيء يعتمد على Tailwind لكن نضيف قواعد بسيطة هنا
       ============================ -->
  <style>
    /* تعليقات عربية داخل CSS */
    /* ضبط اتجاه الكتابة و smooth scrolling */
    html { scroll-behavior: smooth; }
    /* ظل خاص للكروت */
    .card-shadow { box-shadow: 0 6px 18px rgba(2,6,23,0.12); }
    /* جدول متجاوب لنسخة مصغرة */
    .table-scroll { max-height: 360px; overflow:auto; }
    /* تأثير hover للأزرار */
    .btn-hover:hover { transform: translateY(-3px); }
  </style>
</head>

<body class="bg-slate-100 text-slate-900 antialiased">

<!--
  ملاحظة: الهيكل العام للصفحة هو SPA (Single Page Application) داخل ملف HTML واحد.
  سنستخدم أقسام <section> أو <div class="page"> لكل "صفحة" ثم نعرض الصفحة المطلوبة فقط.
  التخزين: all data saved in localStorage keys:
    - products   => array of product objects {id,name,price,category,stock}
    - customers  => array of customer objects {id,name,phone,email}
    - sales      => array of sale objects {id,productId,customerId,quantity,amount,date}
  كل العمليات CRUD مقسمة في السكربت بالأسفل.
-->

<!-- ========== CONTAINER ========== -->
<div id="app" class="min-h-screen flex">

  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-72 bg-gradient-to-b from-primary to-slate-800 text-white p-6 flex flex-col gap-4">
    <!-- شعار / عنوان -->
    <div class="flex items-center gap-3">
      <div class="bg-white/10 p-2 rounded-lg">
        <!-- أيقونة (Lucide) -->
        <svg class="lucide lucide-box w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline></svg>
      </div>
      <div>
        <h1 class="text-xl font-semibold">نظام المحاسبة</h1>
      </div>
    </div>

    <!-- قائمة التنقل -->
    <nav class="flex flex-col gap-1 mt-2">
      <!-- كل زر يستدعي showPage('pageId') -->
      <button onclick="showPage('dashboard')" class="nav-btn flex items-center gap-3 p-3 rounded-lg text-sm hover:bg-white/8 transition">
        <svg class="lucide lucide-home w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7"></path><path d="M9 22V12h6v10"></path></svg>
        لوحة التحكم
      </button>

      <button onclick="showPage('sales')" class="nav-btn flex items-center gap-3 p-3 rounded-lg text-sm hover:bg-white/8 transition">
        <svg class="lucide lucide-credit-card w-5 h-5"><path d="M2 7h20v10H2z"></path><path d="M2 12h20"></path></svg>
        المبيعات
      </button>

      <button onclick="showPage('products')" class="nav-btn flex items-center gap-3 p-3 rounded-lg text-sm hover:bg-white/8 transition">
        <svg class="lucide lucide-package w-5 h-5"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
        المنتجات
      </button>

      <button onclick="showPage('customers')" class="nav-btn flex items-center gap-3 p-3 rounded-lg text-sm hover:bg-white/8 transition">
        <svg class="lucide lucide-users w-5 h-5"><path d="M17 21v-2a4 4 0 0 0-4-4H9"></path><path d="M11 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path></svg>
        العملاء
      </button>

      <button onclick="showPage('reports')" class="nav-btn flex items-center gap-3 p-3 rounded-lg text-sm hover:bg-white/8 transition">
        <svg class="lucide lucide-bar-chart-2 w-5 h-5"><path d="M18 20V10"></path><path d="M12 20V4"></path><path d="M6 20v-6"></path></svg>
        التقارير
      </button>

      <button onclick="showPage('settings')" class="nav-btn flex items-center gap-3 p-3 rounded-lg text-sm hover:bg-white/8 transition">
        <svg class="lucide lucide-settings w-5 h-5"><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82L4.31 3.69A2 2 0 0 1 7.14.86l.06.06A1.65 1.65 0 0 0 9 1.25V1a2 2 0 0 1 4 0v.25c.3.07.58.22.82.45l.06-.06A2 2 0 0 1 19.69 3.69l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09c-.7 0-1.3.5-1.51 1z"></path></svg>
        الإعدادات
      </button>
    </nav>

    <!-- جزء أسفل السايدبار: معلومات صغيرة + زر التبديل -->
    <div class="mt-auto">
      <!-- زر تبديل الوضع -->
      <button id="themeToggle" onclick="toggleTheme()" class="w-full bg-white/10 hover:bg-white/20 py-2 rounded-lg flex items-center justify-center gap-2">
        <svg id="themeIcon" class="w-5 h-5"><!-- icon will be updated by script --></svg>
        تبديل الوضع
      </button>

      <!-- زر التصدير (أيضاً موجود في الـ Dashboard لكن نضع هنا وصول سريع) -->
      <button onclick="exportAllCSV()" class="w-full mt-3 bg-emerald-500 hover:bg-emerald-600 py-2 rounded-lg text-white">
        تصدير بيانات النظام (CSV)
      </button>

      <p class="mt-3 text-xs text-white/70">نظام محاسبه شامل كل الانظمه الممكنه</p>
    </div>
  </aside>

  <!-- ========== MAIN CONTENT ========== -->
  <main class="flex-1 p-6">

    <!-- ====== TOPBAR: عرض مسار و زر إضافة سريع و بحث بسيط ====== -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <h2 id="pageTitle" class="text-2xl font-semibold">لوحة التحكم</h2>
        <p id="breadcrumb" class="text-sm text-slate-500">الرئيسية / لوحة التحكم</p>
      </div>

      <div class="flex items-center gap-3">
        <!-- زر إضافة سريع: يفتح نافذة إضافة مبيعات سريعة -->
        <button onclick="showQuickSaleModal()" class="bg-accent text-white px-4 py-2 rounded-lg shadow btn-hover transition">إضافة بيع سريع</button>
        <!-- بحث بسيط (يبحث في المبيعات والمنتجات والعملاء) -->
        <div class="relative">
          <input id="globalSearch" oninput="globalSearch(this.value)" placeholder="بحث سريع..." class="border rounded-lg px-3 py-2 w-64 focus:outline-accent" />
        </div>
      </div>
    </div>

    <!-- ========== PAGES (كل صفحة مُخبأة ومُدارة بالـ JS) ========== -->

    <!-- ===== DASHBOARD ===== -->
    <section id="dashboard" class="page block">
      <!-- بطاقات الإحصائيات -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- إجمالي المبيعات -->
        <div class="card-shadow rounded-xl p-6 bg-white dark:bg-slate-800 transition">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-lg font-medium">إجمالي المبيعات</h3>
              <p class="text-sm text-slate-500">إجمالي المبالغ المسجلة في النظام</p>
            </div>
            <div class="text-3xl font-bold text-emerald-600" id="dashboardTotalSales">0</div>
          </div>
          <div class="h-1 bg-slate-200 rounded-full overflow-hidden">
            <div id="salesProgress" class="h-1 bg-emerald-400 w-0"></div>
          </div>
        </div>

        <!-- إجمالي الأرباح (نفس المبدأ هنا لأننا لا نفرق بين تكلفة وسعر في التصميم البسيط) -->
        <div class="card-shadow rounded-xl p-6 bg-white dark:bg-slate-800 transition">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-lg font-medium">عدد العمليات</h3>
              <p class="text-sm text-slate-500">عدد فواتير / عمليات البيع</p>
            </div>
            <div class="text-3xl font-bold text-indigo-600" id="dashboardTotalOrders">0</div>
          </div>
          <div class="h-1 bg-slate-200 rounded-full overflow-hidden">
            <div id="ordersProgress" class="h-1 bg-indigo-400 w-0"></div>
          </div>
        </div>

        <!-- أشهر منتج مبيعاً -->
        <div class="card-shadow rounded-xl p-6 bg-white dark:bg-slate-800 transition">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-lg font-medium">أكثر منتج مبيعًا</h3>
              <p class="text-sm text-slate-500">يعتمد على بيانات المبيعات الحالية</p>
            </div>
            <div class="text-3xl font-bold text-rose-600" id="topProductName">—</div>
          </div>
          <div class="h-1 bg-slate-200 rounded-full overflow-hidden">
            <div id="topProductProgress" class="h-1 bg-rose-400 w-0"></div>
          </div>
        </div>
      </div>

      <!-- رسم بياني شهري -->
      <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6 mb-6">
        <h3 class="text-lg font-medium mb-3">مخطط المبيعات الشهري (آخر 12 شهر)</h3>
        <canvas id="monthlyChart" height="120"></canvas>
      </div>

      <!-- جدول آخر العمليات (عرض سريع) -->
      <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">آخر العمليات</h3>
          <!-- زر التصدير العام (CSV) كما طلبت، يتصدّر من هنا -->
          <button onclick="exportAllCSV()" class="bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-lg">تصدير CSV كامل</button>
        </div>

        <div class="table-scroll">
          <table class="min-w-full text-right">
            <thead class="text-sm text-slate-400">
              <tr>
                <th class="py-2 px-3">#</th>
                <th class="py-2 px-3">التاريخ</th>
                <th class="py-2 px-3">العميل</th>
                <th class="py-2 px-3">المنتج</th>
                <th class="py-2 px-3">الكمية</th>
                <th class="py-2 px-3">المبلغ</th>
                <th class="py-2 px-3">إجراءات</th>
              </tr>
            </thead>
            <tbody id="dashboardRecentSales" class="text-sm">
              <!-- سيتم ملؤه ديناميكياً -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== SALES (صفحة المبيعات) ===== -->
    <section id="sales" class="page hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">المبيعات</h2>
        <div class="flex items-center gap-2">
          <button onclick="openSaleForm()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">إضافة عملية جديدة</button>
        </div>
      </div>

      <!-- نموذج إضافة / تعديل البيع -->
      <div id="saleFormCard" class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6 mb-6 hidden">
        <h3 id="saleFormTitle" class="text-lg font-medium mb-3">إضافة عملية بيع</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-sm">العميل</label>
            <select id="saleCustomer" class="w-full border rounded p-2"></select>
          </div>
          <div>
            <label class="text-sm">المنتج</label>
            <select id="saleProduct" class="w-full border rounded p-2"></select>
          </div>
          <div>
            <label class="text-sm">الكمية</label>
            <input id="saleQty" type="number" min="1" value="1" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">السعر لكل وحدة</label>
            <input id="salePrice" type="number" min="0" step="0.01" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">التاريخ</label>
            <input id="saleDate" type="date" class="w-full border rounded p-2" />
          </div>
          <div class="flex items-end gap-2">
            <button onclick="saveSale()" class="bg-blue-600 text-white px-4 py-2 rounded">حفظ</button>
            <button onclick="closeSaleForm()" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>
          </div>
        </div>
      </div>

      <!-- جدول مبيعات -->
      <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
        <h3 class="text-lg mb-4">قائمة المبيعات</h3>
        <div class="table-scroll">
          <table class="min-w-full text-right">
            <thead class="text-sm text-slate-400">
              <tr>
                <th class="py-2 px-3">#</th>
                <th class="py-2 px-3">التاريخ</th>
                <th class="py-2 px-3">العميل</th>
                <th class="py-2 px-3">المنتج</th>
                <th class="py-2 px-3">الكمية</th>
                <th class="py-2 px-3">المبلغ</th>
                <th class="py-2 px-3">إجراءات</th>
              </tr>
            </thead>
            <tbody id="salesTableBody" class="text-sm">
              <!-- سيتم ملؤه بواسطة JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== PRODUCTS (صفحة المنتجات) ===== -->
    <section id="products" class="page hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">المنتجات</h2>
        <div>
          <button onclick="openProductForm()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">إضافة منتج</button>
        </div>
      </div>

      <!-- نموذج إضافة / تعديل المنتجات -->
      <div id="productFormCard" class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6 mb-6 hidden">
        <h3 id="productFormTitle" class="text-lg font-medium mb-3">إضافة منتج</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-sm">اسم المنتج</label>
            <input id="productNameInput" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">السعر</label>
            <input id="productPriceInput" type="number" min="0" step="0.01" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">الفئة</label>
            <input id="productCategoryInput" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">المخزون</label>
            <input id="productStockInput" type="number" min="0" value="0" class="w-full border rounded p-2" />
          </div>
          <div class="flex items-end gap-2">
            <button onclick="saveProduct()" class="bg-blue-600 text-white px-4 py-2 rounded">حفظ</button>
            <button onclick="closeProductForm()" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>
          </div>
        </div>
      </div>

      <!-- جدول المنتجات -->
      <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
        <h3 class="text-lg mb-4">قائمة المنتجات</h3>
        <div class="table-scroll">
          <table class="min-w-full text-right">
            <thead class="text-sm text-slate-400">
              <tr>
                <th class="py-2 px-3">#</th>
                <th class="py-2 px-3">الاسم</th>
                <th class="py-2 px-3">السعر</th>
                <th class="py-2 px-3">الفئة</th>
                <th class="py-2 px-3">المخزون</th>
                <th class="py-2 px-3">إجراءات</th>
              </tr>
            </thead>
            <tbody id="productsTableBody" class="text-sm">
              <!-- سيتم ملؤه بواسطة JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== CUSTOMERS (صفحة العملاء) ===== -->
    <section id="customers" class="page hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">العملاء</h2>
        <div>
          <button onclick="openCustomerForm()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">إضافة عميل</button>
        </div>
      </div>

      <!-- نموذج إضافة / تعديل عميل -->
      <div id="customerFormCard" class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6 mb-6 hidden">
        <h3 id="customerFormTitle" class="text-lg font-medium mb-3">إضافة عميل</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-sm">الاسم</label>
            <input id="customerNameInput" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">الهاتف</label>
            <input id="customerPhoneInput" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">البريد الإلكتروني</label>
            <input id="customerEmailInput" class="w-full border rounded p-2" />
          </div>
          <div class="flex items-end gap-2">
            <button onclick="saveCustomer()" class="bg-blue-600 text-white px-4 py-2 rounded">حفظ</button>
            <button onclick="closeCustomerForm()" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>
          </div>
        </div>
      </div>

      <!-- جدول العملاء -->
      <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
        <h3 class="text-lg mb-4">قائمة العملاء</h3>
        <div class="table-scroll">
          <table class="min-w-full text-right">
            <thead class="text-sm text-slate-400">
              <tr>
                <th class="py-2 px-3">#</th>
                <th class="py-2 px-3">الاسم</th>
                <th class="py-2 px-3">الهاتف</th>
                <th class="py-2 px-3">البريد</th>
                <th class="py-2 px-3">إجراءات</th>
              </tr>
            </thead>
            <tbody id="customersTableBody" class="text-sm">
              <!-- سيتم ملؤه بواسطة JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== REPORTS (صفحة التقارير) ===== -->
    <section id="reports" class="page hidden">
      <div class="mb-4">
        <h2 class="text-xl font-semibold">التقارير</h2>
        <p class="text-sm text-slate-500">يمكنك هنا مشاهدة ملخصات وحفظ التقارير أو طباعتها.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- ملخص إحصائي بسيط -->
        <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
          <h3 class="text-lg font-medium mb-3">ملخص سريع</h3>
          <ul class="text-sm space-y-2">
            <li>إجمالي المبيعات: <span id="reportTotalSales">0</span></li>
            <li>إجمالي العمليات: <span id="reportTotalOrders">0</span></li>
            <li>عدد العملاء: <span id="reportTotalCustomers">0</span></li>
            <li>عدد المنتجات: <span id="reportTotalProducts">0</span></li>
          </ul>
        </div>

        <!-- مخطط دائري لِحِصَص المنتجات إن وُجدت -->
        <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
          <h3 class="text-lg font-medium mb-3">نسبة المبيعات حسب المنتج</h3>
          <canvas id="productShareChart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- ===== SETTINGS (صفحة الإعدادات) ===== -->
    <section id="settings" class="page hidden">
      <div class="mb-4">
        <h2 class="text-xl font-semibold">الإعدادات</h2>
        <p class="text-sm text-slate-500">خيارات حفظ واستيراد البيانات وتخصيص الواجهة.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- استيراد / تصدير بيانات -->
        <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
          <h3 class="text-lg font-medium mb-3">استيراد / تصدير البيانات</h3>
          <div class="flex flex-col gap-3">
            <button onclick="exportAllCSV()" class="bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded">تصدير (CSV)</button>
            <label class="block">
              <span class="text-sm">استيراد ملف JSON (يستبدل البيانات الحالية)</span>
              <input id="importJsonFile" type="file" accept=".json" onchange="importJSON(event)" class="mt-2" />
            </label>
            <button onclick="clearAllData()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">مسح كل البيانات</button>
          </div>
        </div>

        <!-- إعدادات الواجهة -->
        <div class="card-shadow rounded-xl bg-white dark:bg-slate-800 p-6">
          <h3 class="text-lg font-medium mb-3">واجهة</h3>
          <div class="flex flex-col gap-3">
            <label class="flex items-center gap-3">
              <input id="darkModeToggle" type="checkbox" class="form-checkbox" onchange="toggleTheme()" />
              <span>تمكين الوضع الليلي</span>
            </label>
            <label>
              <span class="text-sm">تغيير اتجاه النص</span>
              <select id="dirSelect" class="w-full border rounded p-2 mt-2" onchange="changeDirection(this.value)">
                <option value="rtl">يمين لليسار (العربية)</option>
                <option value="ltr">يسار لليمين (إنجليزي)</option>
              </select>
            </label>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- ============================
     مودال / نوافذ مساعدة (بسيطة) - مخفية افتراضياً
     - نافذة إضافة سريعة للمبيعات
     ============================ -->
<div id="quickSaleModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-11/12 md:w-2/5">
    <h3 class="text-lg font-medium mb-4">إضافة بيع سريع</h3>
    <div class="grid grid-cols-1 gap-3">
      <select id="quickCustomer" class="border p-2 rounded"></select>
      <select id="quickProduct" class="border p-2 rounded"></select>
      <input id="quickQty" type="number" min="1" value="1" class="border p-2 rounded" />
      <input id="quickPrice" type="number" min="0" step="0.01" class="border p-2 rounded" />
      <input id="quickDate" type="date" class="border p-2 rounded" />
      <div class="flex justify-end gap-2">
        <button onclick="saveQuickSale()" class="bg-emerald-500 text-white px-4 py-2 rounded">حفظ</button>
        <button onclick="closeQuickSaleModal()" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>
      </div>
    </div>
  </div>
</div>

<!-- ============================
     سـكـرِبـت: كل منطق التطبيق هنا (تعليقات بالعربية داخل الكود)
     - تحميل البيانات من localStorage
     - وظائف CRUD للمنتجات والعملاء والمبيعات
     - تحديث الرسوم وملء الجداول
     - تصدير CSV واستيراد JSON ومسح البيانات
     ============================ -->
<script>
/* ============================
   تهيئة / جلب البيانات من LocalStorage
   المفتاح: 'app_data'
   يمكن تخزين كل الأقسام (products/customers/sales) داخل كائن واحد
   هيكلة:
   {
     products: [...],
     customers: [...],
     sales: [...]
   }
   ============================ */

// دالة مساعدة لإنشاء UUID مبسّط للعناصر
function uid(prefix = '') {
  return prefix + Math.random().toString(36).slice(2, 9);
}

// جلب البيانات كاملة أو تهيئتها لو كانت غير موجودة
function loadData() {
  const raw = localStorage.getItem('app_data');
  if (!raw) {
    // بداية فارغة كما طلبت (بدون بيانات تجريبية)
    const data = { products: [], customers: [], sales: [] };
    localStorage.setItem('app_data', JSON.stringify(data));
    return data;
  }
  try {
    return JSON.parse(raw);
  } catch (e) {
    console.error('خطأ في قراءة البيانات من localStorage، سيتم تهيئة بيانات جديدة', e);
    const data = { products: [], customers: [], sales: [] };
    localStorage.setItem('app_data', JSON.stringify(data));
    return data;
  }
}

// حفظ البيانات كاملة
function saveData(data) {
  localStorage.setItem('app_data', JSON.stringify(data));
}

/* ============================
   متغيرات الحالة
   ============================ */
let appData = loadData();

/* ============================
   تهيئة الواجهة ووظائف التنقل والـ Theme
   ============================ */

function showPage(id) {
  // تحديث عنوان الصفحة في الـ topbar
  const titleMap = {
    dashboard: 'لوحة التحكم',
    sales: 'المبيعات',
    products: 'المنتجات',
    customers: 'العملاء',
    reports: 'التقارير',
    settings: 'الإعدادات'
  };
  document.getElementById('pageTitle').textContent = titleMap[id] || 'نظام المحاسبة';
  document.getElementById('breadcrumb').textContent = 'الرئيسية / ' + (titleMap[id] || id);

  // إخفاء كل الصفحات ثم إظهار الصفحة المطلوبة
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  const target = document.getElementById(id);
  if (target) {
    target.classList.remove('hidden');
    // إذا كانت الصفحة dashboard: حدث الرسومات والبيانات
    if (id === 'dashboard') updateDashboard();
    if (id === 'sales') updateSalesPage();
    if (id === 'products') updateProductsPage();
    if (id === 'customers') updateCustomersPage();
    if (id === 'reports') updateReportsPage();
    if (id === 'settings') updateSettingsPage();
  }
}

/* ============================
   Theme (Dark/Light Mode)
   - نحفظ الاختيار في localStorage key 'theme'
   ============================ */
function setInitialTheme() {
  const theme = localStorage.getItem('theme') || 'light';
  if (theme === 'dark') document.documentElement.classList.add('dark');
  // تحديث الcheckbox في settings
  const chk = document.getElementById('darkModeToggle');
  if (chk) chk.checked = (theme === 'dark');
  // وسنستخدم class على <html> أو <body> حسب إعداد tailwind؛ نستعمل html.dark
}
function toggleTheme() {
  const isDark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  const chk = document.getElementById('darkModeToggle');
  if (chk) chk.checked = isDark;
}

/* ============================
   تحديث الـ Dashboard (بطاقات + جدول + مخطط)
   ============================ */
let monthlyChart = null;
let productShareChart = null;

function updateDashboard() {
  // تحديث الإحصاءات الأساسية
  const totalSales = appData.sales.reduce((s, x) => s + Number(x.amount || 0), 0);
  const totalOrders = appData.sales.length;
  // لحساب أكثر منتج مبيعًا نقوم بتجميع الكميات حسب productId
  const productCount = {};
  appData.sales.forEach(s => {
    const pid = s.productId;
    productCount[pid] = (productCount[pid] || 0) + Number(s.quantity || 0);
  });
  // العثور على الأعلى
  let topProductName = '—';
  let topQty = 0;
  for (const pid in productCount) {
    if (productCount[pid] > topQty) {
      topQty = productCount[pid];
      const prod = appData.products.find(p => p.id === pid);
      topProductName = prod ? prod.name : pid;
    }
  }

  // تحديث العناصر في DOM
  document.getElementById('dashboardTotalSales').textContent = formatCurrency(totalSales);
  document.getElementById('dashboardTotalOrders').textContent = totalOrders;
  document.getElementById('topProductName').textContent = topProductName || '—';

  // تحديث ال progress bars (نسبةً إلى قيمة معيارية بسيطة: نفترض 10000 كأساس — يمكن تخصيصه)
  const benchmark = 10000;
  const salesPerc = Math.min(100, Math.round((totalSales / benchmark) * 100));
  const ordersPerc = Math.min(100, Math.round((totalOrders / 100) * 100)); // 100 عملية كمرجع
  const topProdPerc = Math.min(100, Math.round((topQty / (topQty || 1)) * 100)); // لو كان topQty 0 => 0%

  document.getElementById('salesProgress').style.width = salesPerc + '%';
  document.getElementById('ordersProgress').style.width = ordersPerc + '%';
  document.getElementById('topProductProgress').style.width = (topQty ? 70 : 0) + '%'; // تقريبياً

  // ملء جدول آخر العمليات في Dashboard (آخر 10 عمليات)
  const recentBody = document.getElementById('dashboardRecentSales');
  recentBody.innerHTML = '';
  const recentSales = [...appData.sales].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,10);
  recentSales.forEach((s, idx) => {
    const customer = appData.customers.find(c=>c.id===s.customerId);
    const product = appData.products.find(p=>p.id===s.productId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${idx+1}</td>
      <td class="p-2">${formatDate(s.date)}</td>
      <td class="p-2">${customer ? customer.name : '—'}</td>
      <td class="p-2">${product ? product.name : '—'}</td>
      <td class="p-2">${s.quantity}</td>
      <td class="p-2">${formatCurrency(s.amount)}</td>
      <td class="p-2">
        <button onclick="editSale('${s.id}')" class="text-blue-600 underline">تعديل</button>
        <button onclick="deleteSale('${s.id}')" class="text-red-600 underline mr-2">حذف</button>
      </td>
    `;
    recentBody.appendChild(tr);
  });

  // تحديث المخطط الشهري
  updateMonthlyChart();
  // أيضًا تحديث تقارير المنتجات
  updateProductShareChart();

  // أيضًا تحديث ملخص صفحة reports
  document.getElementById('reportTotalSales').textContent = formatCurrency(totalSales);
  document.getElementById('reportTotalOrders').textContent = totalOrders;
  document.getElementById('reportTotalCustomers').textContent = appData.customers.length;
  document.getElementById('reportTotalProducts').textContent = appData.products.length;
}

/* ============================
   وظائف المبيعات (Sales)
   - إضافة، تعديل، حذف، عرض
   - عند الإضافة: يتم تقليل المخزون (إن وُجد)
   ============================ */

let editingSaleId = null;

function openSaleForm(editId = null) {
  // ملء قوائم العملاء والمنتجات
  populateSaleSelects();
  // مسح الحقول أو تعبئتها إذا كان تعديل
  document.getElementById('saleFormCard').classList.remove('hidden');
  if (editId) {
    editingSaleId = editId;
    const s = appData.sales.find(x => x.id === editId);
    if (!s) return;
    document.getElementById('saleFormTitle').textContent = 'تعديل عملية البيع';
    document.getElementById('saleCustomer').value = s.customerId || '';
    document.getElementById('saleProduct').value = s.productId || '';
    document.getElementById('saleQty').value = s.quantity || 1;
    document.getElementById('salePrice').value = s.price || s.amount / (s.quantity || 1) || 0;
    document.getElementById('saleDate').value = s.date || '';
  } else {
    editingSaleId = null;
    document.getElementById('saleFormTitle').textContent = 'إضافة عملية بيع';
    document.getElementById('saleCustomer').value = '';
    document.getElementById('saleProduct').value = '';
    document.getElementById('saleQty').value = 1;
    document.getElementById('salePrice').value = '';
    document.getElementById('saleDate').value = new Date().toISOString().slice(0,10);
  }
  // التمرير لأعلى
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function closeSaleForm() {
  document.getElementById('saleFormCard').classList.add('hidden');
  editingSaleId = null;
}

// ملء قوائم العملاء والمنتجات لنموذج البيع
function populateSaleSelects() {
  const custSelect = document.getElementById('saleCustomer');
  const prodSelect = document.getElementById('saleProduct');
  custSelect.innerHTML = '<option value="">-- اختر عميل --</option>';
  prodSelect.innerHTML = '<option value="">-- اختر منتج --</option>';
  appData.customers.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name;
    custSelect.appendChild(opt);
  });
  appData.products.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id; opt.textContent = p.name + ' - ' + formatCurrency(p.price);
    prodSelect.appendChild(opt);
  });
}

// حفظ البيع (إضافة أو تعديل)
function saveSale() {
  const custId = document.getElementById('saleCustomer').value;
  const prodId = document.getElementById('saleProduct').value;
  const qty = Number(document.getElementById('saleQty').value) || 1;
  const price = Number(document.getElementById('salePrice').value) || 0;
  const date = document.getElementById('saleDate').value || (new Date().toISOString().slice(0,10));

  if (!custId || !prodId || qty <= 0 || price <= 0) {
    alert('من فضلك اكمل بيانات البيع بشكل صحيح (عميل، منتج، كمية، سعر).');
    return;
  }

  // المبلغ الإجمالي
  const amount = +(qty * price);

  if (editingSaleId) {
    // تعديل
    const idx = appData.sales.findIndex(x => x.id === editingSaleId);
    if (idx >= 0) {
      // ترجع المخزون القديم ثم تخصم المخزون الجديد (إن كنا ندير المخزون)
      const old = appData.sales[idx];
      // تعديل الكائن
      appData.sales[idx] = { id: editingSaleId, customerId: custId, productId: prodId, quantity: qty, price, amount, date };
      saveData(appData);
      alert('تم تعديل عملية البيع.');
    }
    editingSaleId = null;
  } else {
    // إضافة جديدة
    const newSale = { id: uid('sale_'), customerId: custId, productId: prodId, quantity: qty, price, amount, date };
    appData.sales.push(newSale);
    saveData(appData);
    alert('تم إضافة عملية البيع بنجاح.');
  }

  closeSaleForm();
  updateSalesPage();
  updateDashboard();
}

// حذف بيع
function deleteSale(id) {
  if (!confirm('هل أنت متأكد من حذف هذه العملية؟')) return;
  appData.sales = appData.sales.filter(s => s.id !== id);
  saveData(appData);
  updateSalesPage();
  updateDashboard();
}

// تحرير بيع (فتح النموذج مع المعطيات)
function editSale(id) {
  openSaleForm(id);
}

/* ============================
   صفحة المبيعات - تحديث جدول
   ============================ */
function updateSalesPage() {
  const tbody = document.getElementById('salesTableBody');
  tbody.innerHTML = '';
  // عرض البيانات بترتيب زمني تنازلي
  const list = [...appData.sales].sort((a,b) => new Date(b.date) - new Date(a.date));
  list.forEach((s, idx) => {
    const c = appData.customers.find(x => x.id === s.customerId);
    const p = appData.products.find(x => x.id === s.productId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${idx+1}</td>
      <td class="p-2">${formatDate(s.date)}</td>
      <td class="p-2">${c ? c.name : '—'}</td>
      <td class="p-2">${p ? p.name : '—'}</td>
      <td class="p-2">${s.quantity}</td>
      <td class="p-2">${formatCurrency(s.amount)}</td>
      <td class="p-2">
        <button onclick="editSale('${s.id}')" class="text-blue-600 underline">تعديل</button>
        <button onclick="deleteSale('${s.id}')" class="text-red-600 underline mr-2">حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================
   وظائف المنتجات (Products) - CRUD
   ============================ */

let editingProductId = null;

function openProductForm(editId = null) {
  document.getElementById('productFormCard').classList.remove('hidden');
  if (editId) {
    editingProductId = editId;
    const p = appData.products.find(x => x.id === editId);
    if (!p) return;
    document.getElementById('productFormTitle').textContent = 'تعديل منتج';
    document.getElementById('productNameInput').value = p.name;
    document.getElementById('productPriceInput').value = p.price;
    document.getElementById('productCategoryInput').value = p.category;
    document.getElementById('productStockInput').value = p.stock;
  } else {
    editingProductId = null;
    document.getElementById('productFormTitle').textContent = 'إضافة منتج';
    document.getElementById('productNameInput').value = '';
    document.getElementById('productPriceInput').value = '';
    document.getElementById('productCategoryInput').value = '';
    document.getElementById('productStockInput').value = 0;
  }
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function closeProductForm() {
  document.getElementById('productFormCard').classList.add('hidden');
  editingProductId = null;
}

function saveProduct() {
  const name = document.getElementById('productNameInput').value.trim();
  const price = Number(document.getElementById('productPriceInput').value) || 0;
  const category = document.getElementById('productCategoryInput').value.trim();
  const stock = Number(document.getElementById('productStockInput').value) || 0;

  if (!name || price <= 0) {
    alert('من فضلك أدخل اسم المنتج وسعرًا صالحًا.');
    return;
  }

  if (editingProductId) {
    const idx = appData.products.findIndex(x => x.id === editingProductId);
    if (idx >= 0) {
      appData.products[idx] = { id: editingProductId, name, price, category, stock };
      saveData(appData);
      alert('تم تعديل المنتج.');
    }
    editingProductId = null;
  } else {
    const newP = { id: uid('prod_'), name, price, category, stock };
    appData.products.push(newP);
    saveData(appData);
    alert('تم إضافة المنتج.');
  }

  closeProductForm();
  updateProductsPage();
  updateDashboard();
}

function deleteProduct(id) {
  if (!confirm('هل تريد حذف هذا المنتج؟ سيؤثر ذلك على سجلات المبيعات السابقة.')) return;
  appData.products = appData.products.filter(p => p.id !== id);
  saveData(appData);
  updateProductsPage();
  updateDashboard();
}

function editProduct(id) {
  openProductForm(id);
}

/* ============================
   تحديث صفحة المنتجات (عرض الجدول)
   ============================ */
function updateProductsPage() {
  const tbody = document.getElementById('productsTableBody');
  tbody.innerHTML = '';
  appData.products.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${idx+1}</td>
      <td class="p-2">${p.name}</td>
      <td class="p-2">${formatCurrency(p.price)}</td>
      <td class="p-2">${p.category || '—'}</td>
      <td class="p-2">${p.stock || 0}</td>
      <td class="p-2">
        <button onclick="editProduct('${p.id}')" class="text-blue-600 underline">تعديل</button>
        <button onclick="deleteProduct('${p.id}')" class="text-red-600 underline mr-2">حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================
   وظائف العملاء (Customers) - CRUD
   ============================ */

let editingCustomerId = null;

function openCustomerForm(editId = null) {
  document.getElementById('customerFormCard').classList.remove('hidden');
  if (editId) {
    editingCustomerId = editId;
    const c = appData.customers.find(x => x.id === editId);
    if (!c) return;
    document.getElementById('customerFormTitle').textContent = 'تعديل عميل';
    document.getElementById('customerNameInput').value = c.name;
    document.getElementById('customerPhoneInput').value = c.phone || '';
    document.getElementById('customerEmailInput').value = c.email || '';
  } else {
    editingCustomerId = null;
    document.getElementById('customerFormTitle').textContent = 'إضافة عميل';
    document.getElementById('customerNameInput').value = '';
    document.getElementById('customerPhoneInput').value = '';
    document.getElementById('customerEmailInput').value = '';
  }
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function closeCustomerForm() {
  document.getElementById('customerFormCard').classList.add('hidden');
  editingCustomerId = null;
}

function saveCustomer() {
  const name = document.getElementById('customerNameInput').value.trim();
  const phone = document.getElementById('customerPhoneInput').value.trim();
  const email = document.getElementById('customerEmailInput').value.trim();

  if (!name) {
    alert('برجاء إدخال اسم العميل.');
    return;
  }

  if (editingCustomerId) {
    const idx = appData.customers.findIndex(x => x.id === editingCustomerId);
    if (idx >= 0) {
      appData.customers[idx] = { id: editingCustomerId, name, phone, email };
      saveData(appData);
      alert('تم تعديل بيانات العميل.');
    }
    editingCustomerId = null;
  } else {
    const newC = { id: uid('cust_'), name, phone, email };
    appData.customers.push(newC);
    saveData(appData);
    alert('تم إضافة العميل.');
  }

  closeCustomerForm();
  updateCustomersPage();
  updateDashboard();
}

function deleteCustomer(id) {
  if (!confirm('هل تريد حذف هذا العميل؟ قد يؤثر ذلك على سجلات المبيعات.')) return;
  appData.customers = appData.customers.filter(c => c.id !== id);
  saveData(appData);
  updateCustomersPage();
  updateDashboard();
}

function editCustomer(id) {
  openCustomerForm(id);
}

/* ============================
   تحديث صفحة العملاء
   ============================ */
function updateCustomersPage() {
  const tbody = document.getElementById('customersTableBody');
  tbody.innerHTML = '';
  appData.customers.forEach((c, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${idx+1}</td>
      <td class="p-2">${c.name}</td>
      <td class="p-2">${c.phone || '—'}</td>
      <td class="p-2">${c.email || '—'}</td>
      <td class="p-2">
        <button onclick="editCustomer('${c.id}')" class="text-blue-600 underline">تعديل</button>
        <button onclick="deleteCustomer('${c.id}')" class="text-red-600 underline mr-2">حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================
   تقارير - تحديث مخططات
   ============================ */
function updateReportsPage() {
  // تم تحديث الأرقام في updateDashboard
  // هنا يمكن إضافة وظائف تحميل/طباعة للتقارير إن رغبت
}

/* ============================
   مخطط شهري (Chart.js)
   ============================ */
function updateMonthlyChart() {
  // إعداد مصفوفة 12 عنصر لكل شهر
  const monthly = new Array(12).fill(0);
  appData.sales.forEach(s => {
    const dt = new Date(s.date);
    const m = isNaN(dt.getMonth()) ? new Date().getMonth() : dt.getMonth();
    monthly[m] += Number(s.amount || 0);
  });

  const ctx = document.getElementById('monthlyChart').getContext('2d');

  if (monthlyChart) monthlyChart.destroy();

  monthlyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'],
      datasets: [{
        label: 'المبيعات',
        data: monthly,
        borderColor: '#06b6d4',
        backgroundColor: 'rgba(6,182,212,0.08)',
        tension: 0.3,
        fill: true,
        pointRadius: 3,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index' }
      },
      scales: {
        y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } }
      }
    }
  });
}

/* ============================
   مخطط حصة المنتجات (Pie / Doughnut)
   ============================ */
function updateProductShareChart() {
  const counts = {};
  appData.sales.forEach(s => {
    const pid = s.productId;
    counts[pid] = (counts[pid] || 0) + Number(s.amount || 0);
  });
  const labels = [];
  const data = [];
  for (const pid in counts) {
    const p = appData.products.find(x => x.id === pid);
    labels.push(p ? p.name : pid);
    data.push(counts[pid]);
  }

  const ctx = document.getElementById('productShareChart').getContext('2d');

  if (productShareChart) productShareChart.destroy();

  productShareChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: ['#06b6d4','#f97316','#fb7185','#34d399','#a78bfa','#f59e0b']
      }]
    },
    options: {
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

/* ============================
   Quick Sale Modal (إضافة سريعة)
   ============================ */
function showQuickSaleModal() {
  // ملء القوائم
  const qc = document.getElementById('quickCustomer');
  const qp = document.getElementById('quickProduct');
  qc.innerHTML = '<option value="">-- اختر عميل --</option>';
  qp.innerHTML = '<option value="">-- اختر منتج --</option>';
  appData.customers.forEach(c => qc.appendChild(Object.assign(document.createElement('option'), { value: c.id, textContent: c.name })));
  appData.products.forEach(p => qp.appendChild(Object.assign(document.createElement('option'), { value: p.id, textContent: p.name })));
  // ضبط التاريخ الافتراضي
  document.getElementById('quickDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('quickSaleModal').classList.remove('hidden');
  document.getElementById('quickSaleModal').classList.add('flex');
}

function closeQuickSaleModal() {
  document.getElementById('quickSaleModal').classList.add('hidden');
  document.getElementById('quickSaleModal').classList.remove('flex');
}

function saveQuickSale() {
  const cust = document.getElementById('quickCustomer').value;
  const prod = document.getElementById('quickProduct').value;
  const qty = Number(document.getElementById('quickQty').value) || 1;
  const price = Number(document.getElementById('quickPrice').value) || 0;
  const date = document.getElementById('quickDate').value || new Date().toISOString().slice(0,10);

  if (!cust || !prod || price <= 0) {
    alert('اكمل بيانات البيع السريع: اختر عميلًا ومنتجًا وسعرًا صالحًا.');
    return;
  }

  const amount = qty * price;
  const newSale = { id: uid('sale_'), customerId: cust, productId: prod, quantity: qty, price, amount, date };
  appData.sales.push(newSale);
  saveData(appData);
  closeQuickSaleModal();
  updateSalesPage();
  updateDashboard();
  alert('تمت إضافة البيع السريع.');
}

/* ============================
   Global Search (بحث سريع عبر النظام)
   - يبحث في أسماء المنتجات والعملاء ويعرض نتائج مبسطة في Console (يمكن تطويرها لاحقاً)
   ============================ */
function globalSearch(q) {
  const term = q.trim().toLowerCase();
  if (!term) return;
  const prodRes = appData.products.filter(p => p.name.toLowerCase().includes(term));
  const custRes = appData.customers.filter(c => c.name.toLowerCase().includes(term));
  // عرض مختصر للمستخدم - للتطوير: يمكن فتح نافذة نتائج UI
  console.log('بحث سريـع:', { products: prodRes, customers: custRes });
}

/* ============================
   Export CSV (تصدير بيانات النظام كاملة كملف CSV)
   - سنصدر 3 ملفات مدمجة في ملف واحد بشكل نصي (يمكن فصلها)
   ============================ */
function exportAllCSV() {
  // تبسيط: نص واحد يجمع الأقسام مفصولة بعناوين
  let text = '';
  // منتجات
  text += '=== Products ===\n';
  text += 'id, name, price, category, stock\n';
  appData.products.forEach(p => {
    text += `${escapeCsv(p.id)},${escapeCsv(p.name)},${p.price},${escapeCsv(p.category)},${p.stock}\n`;
  });
  text += '\n';

  // عملاء
  text += '=== Customers ===\n';
  text += 'id, name, phone, email\n';
  appData.customers.forEach(c => {
    text += `${escapeCsv(c.id)},${escapeCsv(c.name)},${escapeCsv(c.phone)},${escapeCsv(c.email)}\n`;
  });
  text += '\n';

  // مبيعات
  text += '=== Sales ===\n';
  text += 'id, date, customerId, customerName, productId, productName, qty, price, amount\n';
  appData.sales.forEach(s => {
    const cust = appData.customers.find(x=>x.id===s.customerId);
    const prod = appData.products.find(x=>x.id===s.productId);
    text += `${escapeCsv(s.id)},${escapeCsv(s.date)},${escapeCsv(s.customerId)},${escapeCsv(cust?cust.name:'')},${escapeCsv(s.productId)},${escapeCsv(prod?prod.name:'')},${s.quantity},${s.price},${s.amount}\n`;
  });

  // تهيئة الملف وتحميله
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `app_data_export_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// مساعد لتجنب مشاكل CSV مع الفواصل أو علامات الاقتباس
function escapeCsv(val) {
  if (val === null || val === undefined) return '';
  const s = String(val);
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return '"' + s.replace(/"/g, '""') + '"';
  }
  return s;
}

/* ============================
   Import JSON (يستبدل البيانات الحالية)
   ============================ */
function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const obj = JSON.parse(e.target.result);
      // نتحقق من الشكل التقريبي
      if (!obj.products || !obj.customers || !obj.sales) {
        alert('ملف JSON غير صالح. تأكد أنه يحتوي على مفاتيح products و customers و sales.');
        return;
      }
      if (!confirm('سيتم استبدال البيانات الحالية بالبيانات من الملف. هل تريد المتابعة؟')) return;
      appData = obj;
      saveData(appData);
      updateAllPages();
      alert('تم استيراد البيانات بنجاح.');
    } catch (err) {
      alert('خطأ في قراءة ملف JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
}

/* ============================
   مسح كل البيانات (تهيئة)
   ============================ */
function clearAllData() {
  if (!confirm('هل تريد مسح كل بيانات النظام؟ هذا الإجراء لا يمكن التراجع عنه.')) return;
  appData = { products: [], customers: [], sales: [] };
  saveData(appData);
  updateAllPages();
}

/* ============================
   تحديث شامل لكل الصفحات عند تغيير بيانات
   ============================ */
function updateAllPages() {
  updateProductsPage();
  updateCustomersPage();
  updateSalesPage();
  updateDashboard();
  updateReportsPage();
}

/* ============================
   مساعدات: صيغ التاريخ والعملة
   ============================ */
function formatDate(d) {
  if (!d) return '—';
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  return dt.toLocaleDateString('ar-EG');
}
function formatCurrency(v) {
  const n = Number(v || 0);
  return n.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', maximumFractionDigits: 2 });
}

/* ============================
   تحميل أولي وتعيين الأحداث
   ============================ */
function init() {
  setInitialTheme();
  // تحويل أيقونات Lucide (module) للمكان الصحيح
  try { if (window.lucide) lucide.replace(); } catch(e){/* ignore */ }

  // عرض الصفحة الرئيسية (لوحة التحكم)
  showPage('dashboard');

  // تهيئة حقول forms الأساسية مثل قوائم المنتجات والعملاء في مودال البيع السريع
  // ونقوم بتحديث الصفحات الأخرى
  updateAllPages();

  // تحديث أيقونات theme button
  updateThemeIcon();
  // ربط عناصر DOM
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  document.getElementById('darkModeToggle').addEventListener('change', toggleTheme);
}

// تحديث أيقونة الوضع (قمر/شمس)
function updateThemeIcon() {
  const isDark = document.documentElement.classList.contains('dark');
  const svgEl = document.getElementById('themeIcon');
  if (!svgEl) return;
  svgEl.innerHTML = isDark
    ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg>'
    : '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2"></path><path d="M12 21v2"></path><path d="M4.22 4.22l1.42 1.42"></path><path d="M18.36 18.36l1.42 1.42"></path><path d="M1 12h2"></path><path d="M21 12h2"></path><path d="M4.22 19.78l1.42-1.42"></path><path d="M18.36 5.64l1.42-1.42"></path></svg>';
}

/* ============================
   مُساعد: عندما تفتح صفحة المنتجات / العملاء يجب أن يتم ملء الـ selects
   (يتم استدعاء هذه الدالة من init وداخل فتح النماذج)
   ============================ */
function populateSaleSelectsOnDemand() {
  const qc = document.getElementById('quickCustomer');
  const qp = document.getElementById('quickProduct');
  if (qc && qp) {
    qc.innerHTML = '<option value="">-- اختر عميل --</option>';
    qp.innerHTML = '<option value="">-- اختر منتج --</option>';
    appData.customers.forEach(c => qc.appendChild(Object.assign(document.createElement('option'), { value: c.id, textContent: c.name })));
    appData.products.forEach(p => qp.appendChild(Object.assign(document.createElement('option'), { value: p.id, textContent: p.name })));
  }
}

/* ============================
   تغيير اتجاه الصفحة (rtl / ltr)
   ============================ */
function changeDirection(dir) {
  document.documentElement.dir = dir;
}

/* ============================
   مساعدة: تنسيق سريع لملء نماذج البيع عند فتحها
   ============================ */
function populateSaleSelects() {
  const custSelect = document.getElementById('saleCustomer');
  const prodSelect = document.getElementById('saleProduct');
  if (!custSelect || !prodSelect) return;
  custSelect.innerHTML = '<option value="">-- اختر عميل --</option>';
  prodSelect.innerHTML = '<option value="">-- اختر منتج --</option>';
  appData.customers.forEach(c => {
    const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name;
    custSelect.appendChild(opt);
  });
  appData.products.forEach(p => {
    const opt = document.createElement('option'); opt.value = p.id; opt.textContent = `${p.name} — ${formatCurrency(p.price)}`;
    prodSelect.appendChild(opt);
  });
}

/* ============================
   بدائل: عند تغيير الـ localStorage من تبويب آخر (نادر)
   ============================ */
window.addEventListener('storage', () => {
  appData = loadData();
  updateAllPages();
});

/* ============================
   تهيئة نهائية عند تحميل الصفحة
   ============================ */
document.addEventListener('DOMContentLoaded', () => {
  init();
  // استدعاء populate للـ quick modal
  populateSaleSelectsOnDemand();
  // ربط إغلاق مودال عند الضغط خارج المحتوى
  document.getElementById('quickSaleModal').addEventListener('click', (e) => {
    if (e.target.id === 'quickSaleModal') closeQuickSaleModal();
  });
});





  // دالة تعديل البيع
  function editSale(id) {
    // هنا تكتب الكود اللي هيعدل بيانات البيع في Local Storage
    // حاليًا مجرد تنبيه علشان تتأكد إن الزر شغال
   // alert("تعديل البيع برقم: " + id);

    // مثال: تجيب البيانات الحالية
    const sales = JSON.parse(localStorage.getItem("sales") || "[]");
    const sale = sales.find(s => s.id === id);

    if (sale) {
      // اعرض بيانات البيع في نموذج التعديل أو أي طريقة تريدها
      console.log("البيع الحالي:", sale);
      // بعدها اكتب كود التحديث الفعلي هنا
    }
  }
</script>

<!-- نهاية الملف -->
</body>
</html>
